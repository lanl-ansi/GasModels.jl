function _IM.solution_preprocessor(gm::AbstractGasModel, solution::Dict)
    solution["is_per_unit"] = gm.data["is_per_unit"]
    solution["multinetwork"] = ismultinetwork(gm.data)
    solution["base_pressure"] = gm.ref[:base_pressure]
    solution["base_flow"] = gm.ref[:base_flow]
    solution["base_time"] = gm.ref[:base_time]
    solution["base_length"] = gm.ref[:base_length]
    solution["base_density"] = gm.ref[:base_density]
end



function sol_psqr_to_p!(gm::AbstractGasModel, solution::Dict)
    if haskey(solution, "nw")
        nws_data = solution["nw"]
    else
        nws_data = Dict("0" => solution)
    end

    for (n, nw_data) in nws_data
        if haskey(nw_data, "junction")
            for (i,junction) in nw_data["junction"]
                if haskey(junction, "psqr")
                    junction["p"] = sqrt(junction["psqr"])
                end
            end
        end
    end
end


function sol_rsqr_to_r!(gm::AbstractGasModel, solution::Dict)
    if haskey(solution, "nw")
        nws_data = solution["nw"]
    else
        nws_data = Dict("0" => solution)
    end

    for (n, nw_data) in nws_data
        if haskey(nw_data, "compressor")
            for (i,compressor) in nw_data["compressor"]
                if haskey(compressor, "rsqr")
                    compressor["r"] = sqrt(compressor["rsqr"])
                end
            end
        end
    end
end


function sol_compressor_p_to_r!(gm::AbstractGasModel, solution::Dict)
    if haskey(solution, "nw")
        nws_data = solution["nw"]
    else
        nws_data = Dict("0" => solution)
    end

    for (n, nw_data) in nws_data
        if haskey(nw_data, "compressor")
            for (k,compressor) in nw_data["compressor"]
                i = ref(gm,:compressor,parse(Int64,k); nw=parse(Int64, n))["fr_junction"]
                j = ref(gm,:compressor,parse(Int64,k); nw=parse(Int64, n))["to_junction"]
                f = compressor["f"]
                pi = nw_data["junction"][string(i)]["psqr"]
                pj = nw_data["junction"][string(j)]["psqr"]

                compressor["r"] = (f >= 0) ? sqrt(pj) / sqrt(pi) : sqrt(pi) / sqrt(pj)
            end
        end
    end
end


function sol_ne_compressor_p_to_r!(gm::AbstractGasModel, solution::Dict)
    if haskey(solution, "nw")
        nws_data = solution["nw"]
    else
        nws_data = Dict("0" => solution)
    end

    for (n, nw_data) in nws_data
        if haskey(nw_data, "ne_compressor")
            for (k,compressor) in nw_data["ne_compressor"]
                i = ref(gm,:ne_compressor,parse(Int64,k); nw=parse(Int64, n))["fr_junction"]
                j = ref(gm,:ne_compressor,parse(Int64,k); nw=parse(Int64, n))["to_junction"]
                f = compressor["f"]
                pi = nw_data["junction"][string(i)]["psqr"]
                pj = nw_data["junction"][string(j)]["psqr"]

                compressor["r"] = (f >= 0) ? sqrt(pj) / sqrt(pi) : sqrt(pi) / sqrt(pj)
            end
        end
    end
end

function sol_regulator_p_to_r!(gm::AbstractGasModel, solution::Dict)
    if haskey(solution, "nw")
        nws_data = solution["nw"]
    else
        nws_data = Dict("0" => solution)
    end

    for (n, nw_data) in nws_data
        if haskey(nw_data, "regulator")
            for (k,regulator) in nw_data["regulator"]
                i = ref(gm,:regulator,parse(Int64,k); nw=parse(Int64, n))["fr_junction"]
                j = ref(gm,:regulator,parse(Int64,k); nw=parse(Int64, n))["to_junction"]
                f = regulator["f"]
                pi = nw_data["junction"][string(i)]["psqr"]
                pj = nw_data["junction"][string(j)]["psqr"]

                regulator["r"] = (f >= 0) ? sqrt(pj) / sqrt(pi) : sqrt(pi) / sqrt(pj)
            end
        end
    end
end
